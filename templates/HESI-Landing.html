<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>HESI Comprehensive System - Nurse Success Study Hub</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='category-style.css') }}">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/static/manifest.json">
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#2f61f3">
    
    <!-- PWA Specific -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Nurse Study">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/static/icons/icon-180.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/static/icons/icon-120.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/static/icons/icon-152.png">
    <link rel="apple-touch-icon" sizes="167x167" href="/static/icons/icon-167.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/icons/icon-180.png">
    
    <style>
        /* Offline indicator */
        .offline-indicator {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          background: linear-gradient(135deg, #ff9800, #f57c00);
          color: white;
          padding: 12px 20px;
          text-align: center;
          font-weight: 600;
          font-size: 14px;
          z-index: 10000;
        }

        .offline-indicator.hidden {
          display: none;
        }

        .back-link {
          display: inline-block;
          color: #0066cc;
          text-decoration: none;
          margin-bottom: 20px;
          font-weight: 500;
        }

        .back-link:hover {
          text-decoration: underline;
        }

        .page-header {
          margin-bottom: 40px;
          padding: 20px 0;
          margin-top: 50px; /* Space for offline indicator */
        }

        .page-header-top {
          display: flex;
          align-items: center;
          gap: 15px;
          margin-bottom: 8px;
        }

        .page-header h1 {
          margin: 0;
          font-size: clamp(28px, 4vw, 44px);
          color: var(--ink);
          font-weight: 800;
          letter-spacing: -0.5px;
        }

        .page-header p {
          margin: 0;
          color: var(--ink-soft);
          font-size: 18px;
          font-weight: 500;
        }

        .header-icon {
          font-size: 2.5em;
        }

        /* Section styling */
        .section {
          background: white;
          border-radius: 16px;
          padding: 28px;
          margin-bottom: 28px;
          box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        }

        .section-header {
          display: flex;
          align-items: center;
          gap: 12px;
          margin-bottom: 20px;
        }

        .section-header h2 {
          margin: 0;
          font-size: 1.5em;
          color: var(--ink);
          font-weight: 700;
        }

        .section-icon {
          font-size: 1.8em;
        }

        .section-description {
          color: var(--ink-soft);
          font-size: 0.95em;
          line-height: 1.6;
          margin-bottom: 20px;
        }

        /* Component 1: Comprehensive Quiz Card */
        .comprehensive-card {
          background: linear-gradient(135deg, #2f61f3 0%, #45B7D1 100%);
          border-radius: 16px;
          padding: 32px;
          color: white;
          margin-bottom: 24px;
        }

        .comprehensive-card h3 {
          margin: 0 0 12px 0;
          font-size: 1.6em;
          font-weight: 700;
        }

        .comprehensive-card p {
          margin: 0 0 20px 0;
          opacity: 0.95;
          line-height: 1.6;
        }

        .comprehensive-card .weight-info {
          background: rgba(255, 255, 255, 0.15);
          border-radius: 10px;
          padding: 16px;
          margin-bottom: 20px;
        }

        .comprehensive-card .weight-info strong {
          display: block;
          margin-bottom: 8px;
        }

        .comprehensive-btn {
          display: inline-block;
          background: white;
          color: #2f61f3;
          padding: 14px 28px;
          border-radius: 10px;
          text-decoration: none;
          font-weight: 700;
          font-size: 1.05em;
          transition: all 0.3s ease;
        }

        .comprehensive-btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        /* Component 2: Categories Grid */
        .categories-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
          gap: 20px;
        }

        .category-card {
          background: white;
          border: 2px solid #e0e0e0;
          border-radius: 12px;
          padding: 20px;
          text-decoration: none;
          color: inherit;
          transition: all 0.3s ease;
          display: flex;
          flex-direction: column;
        }

        .category-card:hover {
          border-color: #45B7D1;
          transform: translateY(-4px);
          box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .category-card-header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: 12px;
        }

        .category-card h4 {
          margin: 0;
          font-size: 1.1em;
          color: var(--ink);
          flex: 1;
          font-weight: 700;
        }

        .category-weight {
          background: rgba(47, 97, 243, 0.1);
          color: #2f61f3;
          padding: 4px 10px;
          border-radius: 20px;
          font-size: 0.8em;
          font-weight: 700;
        }

        .category-count {
          color: var(--ink-soft);
          font-size: 0.9em;
          margin-top: 4px;
        }

        .category-card .practice-link {
          margin-top: auto;
          padding-top: 12px;
          color: #2f61f3;
          font-weight: 600;
          font-size: 0.9em;
        }

        /* Component 3: Scoreboard */
        .scoreboard {
          background: #f8f9fa;
          border-radius: 12px;
          padding: 20px;
        }

        .scoreboard-empty {
          text-align: center;
          padding: 40px 20px;
          color: var(--ink-soft);
        }

        .scoreboard-empty .empty-icon {
          font-size: 3em;
          margin-bottom: 16px;
          opacity: 0.5;
        }

        .scoreboard-empty p {
          margin: 0;
          line-height: 1.6;
        }

        .focus-area {
          background: white;
          border-radius: 10px;
          padding: 16px;
          margin-bottom: 12px;
          border-left: 4px solid #f44336;
          transition: all 0.2s ease;
        }

        .focus-area:hover {
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .focus-area.yellow {
          border-left-color: #ff9800;
        }

        .focus-area.green {
          border-left-color: #8B5CF6;
        }

        .focus-area-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 8px;
        }

        .focus-area h4 {
          margin: 0;
          font-size: 1em;
          color: var(--ink);
          font-weight: 700;
        }

        .focus-area .score {
          font-weight: 700;
          font-size: 1.1em;
        }

        .focus-area .score.red {
          color: #f44336;
        }

        .focus-area .score.yellow {
          color: #ff9800;
        }

        .focus-area .score.green {
          color: #8B5CF6;
        }

        .focus-area .prompt {
          color: var(--ink-soft);
          font-size: 0.85em;
          margin-bottom: 10px;
        }

        .focus-area .progress-bar {
          height: 8px;
          background: #e0e0e0;
          border-radius: 4px;
          overflow: hidden;
          margin-bottom: 10px;
        }

        .focus-area .progress-fill {
          height: 100%;
          border-radius: 4px;
          transition: width 0.3s ease;
        }

        .focus-area .progress-fill.red {
          background: #f44336;
        }

        .focus-area .progress-fill.yellow {
          background: #ff9800;
        }

        .focus-area .progress-fill.green {
          background: #8B5CF6;
        }

        .focus-area .practice-btn {
          display: inline-block;
          background: transparent;
          border: 2px solid #2f61f3;
          color: #2f61f3;
          padding: 8px 16px;
          border-radius: 6px;
          text-decoration: none;
          font-weight: 600;
          font-size: 0.85em;
          transition: all 0.2s ease;
        }

        .focus-area .practice-btn:hover {
          background: #2f61f3;
          color: white;
        }

        .reset-stats-btn {
          display: inline-block;
          background: transparent;
          border: 2px solid #f44336;
          color: #f44336;
          padding: 10px 20px;
          border-radius: 8px;
          font-weight: 600;
          font-size: 0.9em;
          cursor: pointer;
          transition: all 0.2s ease;
          margin-top: 16px;
          font-family: inherit;
        }

        .reset-stats-btn:hover {
          background: #f44336;
          color: white;
        }

        /* Info box */
        .info-box {
          margin-top: 30px;
          padding: 25px;
          background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
          border-radius: 12px;
          border-left: 4px solid #2f61f3;
        }

        .info-box h3 {
          color: #1565c0;
          margin: 0 0 12px 0;
          font-size: 1.15em;
          font-weight: 700;
        }

        .info-box p {
          color: #555;
          margin: 0;
          line-height: 1.7;
          font-size: 0.95em;
        }

        /* Safe area insets for iOS PWA */
        @supports (padding-top: env(safe-area-inset-top)) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
            }
        }

        @media (max-width: 768px) {
            .page-header h1 {
              font-size: 28px;
            }

            .categories-grid {
              grid-template-columns: 1fr;
            }

            .comprehensive-card {
              padding: 24px;
            }

            .section {
              padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Offline indicator -->
    <div id="offlineIndicator" class="offline-indicator hidden">
        <span>üì¥ You're offline - Using cached content</span>
    </div>

    <div class="container">
        <a href="/" class="back-link">‚Üê Nurse Success Study Hub</a>
        
        <div class="page-header">
            <div class="page-header-top">
                <span class="header-icon">üìã</span>
                <h1>HESI Comprehensive System</h1>
            </div>
            <p>NCLEX-weighted practice with performance tracking across all 8 test plan categories</p>
        </div>

        <!-- COMPONENT 1: HESI Comprehensive Quiz -->
        <div class="section">
            <div class="section-header">
                <span class="section-icon">üéØ</span>
                <h2>HESI Comprehensive Quiz (NCLEX-Weighted)</h2>
            </div>
            <div class="comprehensive-card">
                <h3>Master the NCLEX Test Plan</h3>
                <p>Take a comprehensive quiz with questions distributed according to the official NCLEX-RN test plan percentages. Your performance is tracked across all 8 categories to identify areas needing more practice.</p>
                <div class="weight-info">
                    <strong>üìä Question Distribution:</strong>
                    Questions are weighted by NCLEX category: Management of Care (18%), Pharmacological Therapies (16%), Physiological Adaptation (14%), Safety & Infection Control (13%), Reduction of Risk (12%), and more.
                </div>
                <a href="/category/HESI/NCLEX_Comprehensive" class="comprehensive-btn">Start Comprehensive Quiz ‚Üí</a>
            </div>
        </div>

        <!-- COMPONENT 2: HESI Categories -->
        <div class="section">
            <div class="section-header">
                <span class="section-icon">üìö</span>
                <h2>Practice by NCLEX Category</h2>
            </div>
            <p class="section-description">Focus on specific NCLEX-RN test plan categories. Category quizzes do NOT affect your performance scoreboard - they're for targeted practice only.</p>
            
            <div class="categories-grid">
                {% for cat_name, weight in nclex_categories.items() %}
                <a href="/category/HESI/category/{{ cat_name | urlencode }}" class="category-card">
                    <div class="category-card-header">
                        <h4>{{ cat_name }}</h4>
                        <span class="category-weight">{{ (weight * 100) | int }}%</span>
                    </div>
                    <p class="category-count">{{ category_stats[cat_name].count }} questions available</p>
                    <span class="practice-link">Practice this category ‚Üí</span>
                </a>
                {% endfor %}
            </div>
        </div>

        <!-- COMPONENT 3: Areas of Focus Scoreboard -->
        <div class="section">
            <div class="section-header">
                <span class="section-icon">üìà</span>
                <h2>Areas of Focus</h2>
            </div>
            <p class="section-description">Your top 5 categories needing improvement, ranked by weighted priority score. Complete comprehensive quizzes to see your personalized areas of focus.</p>
            
            <div class="scoreboard" id="scoreboard">
                <!-- Will be populated by JavaScript -->
                <div class="scoreboard-empty" id="scoreboardEmpty">
                    <div class="empty-icon">üìä</div>
                    <p><strong>No data yet</strong><br>Complete a comprehensive quiz to see your areas of focus</p>
                </div>
                <div id="scoreboardContent" style="display: none;"></div>
            </div>
            
            <button class="reset-stats-btn" id="resetStatsBtn" style="display: none;">üóëÔ∏è Reset All Stats</button>
        </div>

        <!-- Info Box -->
        <div class="info-box">
            <h3>üìö About the HESI Comprehensive System</h3>
            <p>This system uses {{ total_questions }} questions from HESI Exit Exam and Comprehensive study guides, categorized according to the NCLEX-RN test plan. The comprehensive quiz weights questions by NCLEX percentages to simulate real exam conditions. Your performance is tracked to help you identify and strengthen weak areas. Category quizzes are for targeted practice and don't affect your overall stats.</p>
        </div>
    </div>

    <!-- PWA Utilities -->
    <script src="/static/js/pwa-utils.js"></script>

    <script>
        // NCLEX Categories with weights
        const NCLEX_WEIGHTS = {
            'Management of Care': 0.18,
            'Safety and Infection Control': 0.13,
            'Health Promotion and Maintenance': 0.09,
            'Psychosocial Integrity': 0.09,
            'Basic Care and Comfort': 0.09,
            'Pharmacological and Parenteral Therapies': 0.16,
            'Reduction of Risk Potential': 0.12,
            'Physiological Adaptation': 0.14
        };

        const STORAGE_KEY = 'hesiPerformanceStats';

        // Load stats from localStorage
        function loadStats() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (!raw) return null;
                return JSON.parse(raw);
            } catch (e) {
                console.error('Error loading stats:', e);
                return null;
            }
        }

        // Calculate priority score: (100 - score%) * NCLEX weight
        function calculatePriorityScore(percentage, weight) {
            return (100 - percentage) * weight;
        }

        // Get color class based on percentage (PART 2: APPROVED PURPLE THRESHOLD)
        function getColorClass(percentage) {
            if (percentage < 60) return 'red';
            if (percentage < 75) return 'yellow';
            return 'green';
        }

        // Render the scoreboard
        function renderScoreboard() {
            const stats = loadStats();
            const emptyEl = document.getElementById('scoreboardEmpty');
            const contentEl = document.getElementById('scoreboardContent');
            const resetBtn = document.getElementById('resetStatsBtn');

            if (!stats || Object.keys(stats).length === 0) {
                emptyEl.style.display = 'block';
                contentEl.style.display = 'none';
                resetBtn.style.display = 'none';
                return;
            }

            // Check if any category has data
            const categoriesWithData = Object.entries(stats).filter(([cat, data]) => 
                data && data.totalAnswered > 0
            );

            if (categoriesWithData.length === 0) {
                emptyEl.style.display = 'block';
                contentEl.style.display = 'none';
                resetBtn.style.display = 'none';
                return;
            }

            // Calculate priority scores and sort
            const rankedCategories = categoriesWithData.map(([cat, data]) => {
                const percentage = data.totalAnswered > 0 
                    ? Math.round((data.totalCorrect / data.totalAnswered) * 100) 
                    : 0;
                const weight = NCLEX_WEIGHTS[cat] || 0.1;
                const priorityScore = calculatePriorityScore(percentage, weight);
                return {
                    name: cat,
                    percentage,
                    weight,
                    priorityScore,
                    totalAnswered: data.totalAnswered,
                    totalCorrect: data.totalCorrect
                };
            }).sort((a, b) => b.priorityScore - a.priorityScore);

            // Take top 5
            const top5 = rankedCategories.slice(0, 5);

            // Render
            emptyEl.style.display = 'none';
            contentEl.style.display = 'block';
            resetBtn.style.display = 'inline-block';

            contentEl.innerHTML = top5.map(cat => {
                const colorClass = getColorClass(cat.percentage);
                const borderClass = colorClass === 'red' ? '' : colorClass;
                const prompt = cat.percentage < 60 
                    ? `You're struggling with ${cat.name}. Click to practice this area.`
                    : cat.percentage < 75
                    ? `${cat.name} needs some work. Practice to improve.`
                    : `Good progress on ${cat.name}! Keep it up.`;

                return `
                    <div class="focus-area ${borderClass}">
                        <div class="focus-area-header">
                            <h4>${cat.name}</h4>
                            <span class="score ${colorClass}">${cat.percentage}%</span>
                        </div>
                        <p class="prompt">${prompt}</p>
                        <div class="progress-bar">
                            <div class="progress-fill ${colorClass}" style="width: ${cat.percentage}%"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.85em; color: #666;">
                            <span>${cat.totalCorrect}/${cat.totalAnswered} correct ‚Ä¢ NCLEX weight: ${Math.round(cat.weight * 100)}%</span>
                            <a href="/category/HESI/category/${encodeURIComponent(cat.name)}" class="practice-btn">Practice ‚Üí</a>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Reset stats
        function resetStats() {
            if (confirm('Are you sure you want to reset all HESI performance stats? This cannot be undone.')) {
                localStorage.removeItem(STORAGE_KEY);
                renderScoreboard();
            }
        }

        // Event listeners
        document.getElementById('resetStatsBtn').addEventListener('click', resetStats);

        // Initial render
        document.addEventListener('DOMContentLoaded', renderScoreboard);

        // Listen for storage changes (if user completes quiz in another tab)
        window.addEventListener('storage', (e) => {
            if (e.key === STORAGE_KEY) {
                renderScoreboard();
            }
        });
    </script>
</body>
</html>
