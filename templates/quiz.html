<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="description" content="Quiz - Nurse Success Study Hub">
  <title id="pageTitle">Quiz - Nurse Success Study Hub</title>
  <link rel="stylesheet" href="/static/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/static/manifest.json">
  
  <!-- Theme Color -->
  <meta name="theme-color" content="#2f61f3">
  
  <!-- PWA Specific -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Nurse Study">
  
  <!-- Apple Touch Icons - All Sizes -->
  <link rel="apple-touch-icon" href="/static/icons/icon-180.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/static/icons/icon-120.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/static/icons/icon-152.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/static/icons/icon-167.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/static/icons/icon-180.png">
  
  <!-- Vercel Analytics -->
  <script defer src="https://cdn.vercel-analytics.com/v1/web.js"></script>

  <style>
    /* Offline indicator */
    .offline-indicator {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #ff9800, #f57c00);
      color: white;
      padding: 12px 20px;
      text-align: center;
      font-weight: 600;
      font-size: 14px;
      z-index: 10000;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .offline-indicator.hidden {
      display: none;
    }

    .launcher-title-wrapper {
      margin-bottom: 24px;
    }

    .launcher-title {
      margin: 0 0 8px 0;
      font-size: 28px;
      font-weight: 700;
    }

    .launcher-description {
      color: var(--ink-soft);
      font-size: 16px;
      margin: 0;
      line-height: 1.6;
    }

    .launcher-badge {
      display: inline-block;
      margin-bottom: 16px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .badge-standard {
      background-color: rgba(69, 183, 209, 0.15);
      color: #45B7D1;
    }

    .badge-ccrn {
      background-color: rgba(229, 57, 53, 0.15);
      color: #e53935;
    }

    .module-selector-group {
      display: none;
    }

    .module-selector-group.show {
      display: block;
    }

    .module-selector-group.hidden-for-preloaded {
      display: none !important;
    }
    
    /* Safe area insets for iOS PWA */
    @supports (padding-top: env(safe-area-inset-top)) {
      body {
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
        padding-left: env(safe-area-inset-left);
        padding-right: env(safe-area-inset-right);
      }
      
      .offline-indicator {
        padding-top: calc(12px + env(safe-area-inset-top));
      }
    }
  </style>
</head>
<body>
  <!-- Offline indicator -->
  <div id="offlineIndicator" class="offline-indicator hidden">
    <span>üì¥ You're offline - Using cached content</span>
  </div>

  <div class="container">
    <!-- Title Bar -->
    <div class="title-bar">
      <div>
        <a href="{{ back_url if back_url else '/' }}" id="backLink" style="color: var(--primary); text-decoration: none; font-weight: 600; margin-bottom: 4px; display: inline-block; font-size: 14px;">‚Üê {{ back_label if back_label else 'Nurse Success Study Hub' }}</a>
        <h1 id="quizTitle">Select a Module</h1>
        <p id="quizDescription" style="color: var(--ink-soft); margin: 8px 0 0 0; font-size: 14px; display: none;"></p>
      </div>
      <div id="resumeContainer" class="resume-container hidden">
        <span id="remainingQuestionsCount" class="remaining-count"></span>
        <button class="btn btn-blue" id="resumeBtn">Resume Quiz</button>
      </div>
    </div>

    <!-- Setup Card -->
    <div class="card" id="launcher">
      <!-- Custom Header for Preloaded Data -->
      <div class="launcher-title-wrapper" id="preloadedTitleWrapper" style="display: none;">
        <span class="launcher-badge badge-standard" id="preloadedBadge">STANDARD</span>
        <h2 class="launcher-title" id="preloadedTitle"></h2>
        <p class="launcher-description" id="preloadedDescription"></p>
      </div>

      <!-- Default Quiz Setup Title -->
      <h2 id="defaultTitle" style="display: none; margin: 0 0 20px 0;">Quiz Setup</h2>
      
      <!-- Module Selector (hidden for preloaded data) -->
      <div class="module-selector-group" id="moduleSelectorGroup">
        <div class="field">
          <label for="moduleSel">Select Module:</label>
          <select id="moduleSel">
            <option value="">Loading modules...</option>
          </select>
        </div>
      </div>

      <div class="field">
        <label>How many questions?</label>
        <div class="seg" id="lengthBtns">
          <button class="seg-btn active" data-len="10">10 Questions</button>
          <button class="seg-btn" data-len="25">25 Questions</button>
          <button class="seg-btn" data-len="50">50 Questions</button>
          <button class="seg-btn" data-len="full">Full Module Question Bank</button>
        </div>
      </div>

      <div class="actions">
        <button class="btn primary" id="startBtn">Start Quiz</button>
      </div>

      <!-- How This Quiz Works -->
      <div class="help">
        <h3>How This Quiz Works</h3>
        <ul>
          <li><strong>Select All That Apply (SATA):</strong> Some questions allow multiple correct answers. Select all options you believe are correct.</li>
          <li><strong>Single Answer:</strong> Questions without "Select all that apply" have only one correct answer.</li>
          <li><strong>Mastery System:</strong> If you answer incorrectly, the question will reappear. The quiz ends when all questions are answered correctly.</li>
          <li><strong>Keyboard Shortcuts:</strong> Press A-D to select answers, Enter to submit.</li>
          <li><strong>Resume Feature:</strong> If you select "Full Module Question Bank", your progress is saved and you can resume later.</li>
          <li><strong>Offline Mode:</strong> This app works offline! Your progress is saved locally.</li>
        </ul>
      </div>
    </div>

    <!-- Quiz Card -->
    <div class="card hidden" id="quiz">
      <!-- Counters -->
      <div id="countersBox" class="hidden">
        <div style="display: flex; justify-content: space-between; margin-bottom: 10px; flex-wrap: wrap; gap: 8px;">
          <span id="runCounter" style="font-weight: 600; font-size: 14px;">Question: 1</span>
          <span id="remainingCounter" style="font-weight: 600; font-size: 14px;">Remaining to master: 0</span>
        </div>
        <div style="position: relative; margin-bottom: 16px;">
          <div id="progressBar" class="pbar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
            <div id="progressFill" class="pbar-fill"></div>
            <div id="progressLabel" class="pbar-label">0% mastered</div>
          </div>
        </div>
      </div>

      <div id="questionText" class="question"></div>
      <form id="optionsForm" class="options"></form>
      <div id="feedback" class="feedback hidden"></div>
      <div id="answerLine" class="answer-line hidden"></div>
      <div id="rationale" class="rationale hidden"></div>

      <div class="actions">
        <button class="btn primary" id="submitBtn">Submit Answer</button>
      </div>
    </div>

    <!-- Summary Card -->
    <div class="card hidden" id="summary">
      <h2>Quiz Complete! üéâ</h2>
      <div id="firstTrySummary" class="first-try hidden"></div>

      <!-- Action Buttons -->
      <div class="actions" style="margin-bottom: 24px;">
        <button class="btn danger hidden" id="retryMissedBtn">Retry <span id="missedCount">0</span> Missed Questions</button>
        <button class="btn primary" id="restartBtnSummary">Start New Quiz</button>
      </div>

      <!-- Help Section -->
      <div class="help" style="margin-top: 0; margin-bottom: 32px;">
        <h3>Need More Practice?</h3>
        <ul>
          <li>Review the rationales for questions you missed</li>
          <li>Try the "Retry Missed Questions" feature to focus on weak areas</li>
          <li>Consider a shorter quiz length for more frequent practice sessions</li>
          <li>Use the keyboard shortcuts (A-D, Enter) for faster navigation</li>
        </ul>
      </div>

      <h3>Review Your Answers:</h3>
      <div id="reviewList" class="review-list"></div>
    </div>

    <!-- Reset Button (hidden initially) -->
    <button class="btn danger hidden" id="resetAll" style="position: fixed; top: 20px; right: 20px; z-index: 1000;">Reset Quiz</button>
  </div>

  <!-- PWA Utilities -->
  <script src="/static/js/pwa-utils.js"></script>

  <script>
    // Check if quiz data was passed from the server
    window.preloadedQuizData = null;
    window.preloadedModuleName = null;
    window.preloadedCategory = null;
    window.backUrl = null;
    window.backLabel = null;
    
    {% if quiz_data %}
      window.preloadedQuizData = {{ quiz_data | tojson }};
      window.preloadedModuleName = "{{ module_name }}";
      window.preloadedCategory = "{{ category }}";
    {% endif %}
    
    {% if back_url %}
      window.backUrl = "{{ back_url }}";
      window.backLabel = "{{ back_label }}";
    {% endif %}
  </script>

  <script src="/static/quiz-script.js"></script>
</body>
</html>
