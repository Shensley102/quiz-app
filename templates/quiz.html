<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="description" content="Quiz - Nurse Success Study Hub">
  <title id="pageTitle">Quiz - Nurse Success Study Hub</title>
  <link rel="stylesheet" href="/static/style.css">
  <link rel="stylesheet" href="/static/quiz-style.css">
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/static/manifest.json">
  
  <!-- Theme Color -->
  <meta name="theme-color" content="#2f61f3">
  
  <!-- PWA Specific -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Nurse Study">
  
  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="/static/icons/icon-180.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/static/icons/icon-120.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/static/icons/icon-152.png">
  <link rel="apple-touch-icon" sizes="167x167" href="/static/icons/icon-167.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/static/icons/icon-180.png">
  
  <!-- Vercel Analytics -->
  <script defer src="/_vercel/insights/script.js"></script>

  <style>
    .offline-indicator {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #ff9800, #f57c00);
      color: white;
      padding: 12px 20px;
      text-align: center;
      font-weight: 600;
      font-size: 14px;
      z-index: 10000;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    .offline-indicator.hidden { display: none; }
    
    /* Return button styling */
    .return-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 14px 12px;
      margin-top: 0;
      background: #6c757d;
      color: white;
      text-align: center;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 1em;
      line-height: 1.3;
      transition: background 0.2s;
    }
    .return-btn:hover {
      background: #5a6268;
      color: white;
      text-decoration: none;
    }
    
    /* Review item styling improvements */
    .review-item {
      padding: 16px;
      margin-bottom: 16px;
      border-radius: 8px;
      border-left: 4px solid #ccc;
      background: #f8f9fa;
    }
    .review-item.review-correct {
      border-left-color: #4caf50;
      background: #f1f8e9;
    }
    .review-item.review-incorrect {
      border-left-color: #f44336;
      background: #ffebee;
    }
    .review-question {
      margin-bottom: 12px;
      font-size: 1em;
      line-height: 1.5;
    }
    .review-correct-answer {
      margin-bottom: 8px;
      color: #2e7d32;
    }
    .review-rationale {
      color: #555;
      font-size: 0.95em;
      line-height: 1.5;
      padding-top: 8px;
      border-top: 1px solid #ddd;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <!-- Offline indicator -->
  <div id="offlineIndicator" class="offline-indicator hidden">
    <span>üì¥ You're offline - Using cached content</span>
  </div>

  <div class="container">
    <!-- Title Bar -->
    <div class="title-bar">
      <div>
        <a href="{{ back_url if back_url else '/' }}" id="backLink" style="color: var(--primary); text-decoration: none; font-weight: 600; margin-bottom: 4px; display: inline-block; font-size: 14px;">‚Üê {{ back_label if back_label else 'Home' }}</a>
        <h1 id="pageTitle">{{ module_name | replace('_', ' ') if module_name else 'Select a Module' }}</h1>
      </div>
    </div>

    <!-- Module Launcher (hidden if preloaded data with autostart) -->
    <div class="card" id="launcher">
      <div id="categoryHeader" class="category-header">
        <span id="categoryIcon" class="category-icon"></span>
        <div>
          <h2 id="categoryTitle">Quiz Selection</h2>
          <p id="categoryDescription" style="display: none;"></p>
        </div>
      </div>

      <label for="moduleSel" class="label">Select Module:</label>
      <select id="moduleSel" class="select">
        <option value="">-- Select a Module --</option>
      </select>

      <label class="label" style="margin-top: 16px;">Quiz Length:</label>
      <div id="lengthBtns" class="seg-btns">
        <button class="seg-btn" data-len="10">10</button>
        <button class="seg-btn" data-len="25">25</button>
        <button class="seg-btn active" data-len="50">50</button>
        <button class="seg-btn" data-len="100">100</button>
      </div>

      <button class="btn primary" id="startBtn" disabled>Start Quiz</button>
      <button class="btn btn-blue hidden" id="resumeBtn">Resume Last Quiz</button>
    </div>

    <!-- Reset Quiz Button -->
    <button class="btn danger hidden" id="resetBtn" style="position: fixed; top: 20px; right: 20px; z-index: 1000;">Reset Quiz</button>

    <!-- Quiz Questions -->
    <div id="quiz" class="card hidden">
      <div id="countersBox" class="counters hidden">
        <span id="runCounter">Question 1 of 10</span>
        <span id="remainingCounter">10 remaining</span>
      </div>

      <div id="progressBar" class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
        <div id="progressFill" class="progress-fill"></div>
        <span id="progressLabel" class="progress-label">0% mastered</span>
      </div>

      <p id="questionText" class="question-text"></p>

      <form id="optionsForm" class="options-form"></form>

      <button class="btn primary" id="submitBtn" disabled data-mode="submit">Submit</button>

      <div id="feedback" class="feedback hidden"></div>
      <div id="answerLine" class="answer-line hidden"></div>
      <div id="rationale" class="rationale hidden"></div>
    </div>

    <!-- Summary -->
    <div id="summary" class="card hidden">
      <h2 id="summaryTitle" style="text-align: center; font-size: 2.4em; margin-bottom: 24px;">üéâ Quiz Complete!</h2>
      
      <div id="firstTrySummary" class="first-try"></div>

      <div class="actions" id="summaryActions" style="margin-bottom: 24px; display: flex; gap: 12px; flex-wrap: nowrap; align-items: stretch;">
        <button class="btn danger hidden" id="retryMissedBtn" style="flex: 1; min-width: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; line-height: 1.3;">
          <span>Retry Missed Questions</span>
          <span id="missedCountDisplay" style="font-size: 0.85em; opacity: 0.9;">(0)</span>
        </button>
        <button class="btn primary" id="restartBtnSummary" style="flex: 4; min-width: 0;">Start New Quiz</button>
        <!-- Return button will be dynamically inserted here by JS -->
      </div>

      <h3>Review All Questions:</h3>
      <div id="reviewList" class="review-list"></div>
    </div>
  </div>

  <!-- Progress Store -->
  <script src="/static/js/progress-store.js"></script>

  <!-- PWA Utilities -->
  <script src="/static/js/pwa-utils.js"></script>

  <!-- Server-side data injection -->
  <script>
    // Build a SINGLE preloadedQuizData object with ALL necessary properties
    // This is what quiz-script.js expects
    window.preloadedQuizData = null;
    
    {% if quiz_data %}
    (function() {
      // Get the raw quiz data from Flask
      var rawQuizData = {{ quiz_data | tojson }};
      
      // Get URL parameters
      var params = new URLSearchParams(window.location.search);
      var urlQuizLength = params.get('quiz_length');
      var urlIsComprehensive = params.get('is_comprehensive') === 'true';
      var urlAutostart = params.get('autostart') === 'true';
      
      // Build the unified preloadedQuizData object
      window.preloadedQuizData = {
        // Questions from the JSON file
        questions: rawQuizData.questions || [],
        
        // Metadata
        moduleName: "{{ module_name | default('Quiz', true) }}",
        category: "{{ category | default('General', true) }}",
        description: rawQuizData.description || '',
        title: rawQuizData.title || '',
        total_questions: rawQuizData.questions ? rawQuizData.questions.length : 0,
        
        // Quiz flags - from Flask template variables OR URL parameters
        isComprehensive: {% if is_comprehensive is defined %}{{ is_comprehensive | tojson }}{% else %}false{% endif %} || urlIsComprehensive,
        isCategoryQuiz: {% if is_category_quiz is defined %}{{ is_category_quiz | tojson }}{% else %}false{% endif %},
        autostart: {% if autostart is defined %}{{ autostart | tojson }}{% else %}false{% endif %} || urlAutostart,
        
        // Quiz length - from Flask template variable OR URL parameter
        quizLength: urlQuizLength || "{{ quiz_length | default('full', true) }}"
      };
      
      // Also set these as window properties for backward compatibility
      window.preloadedModuleName = window.preloadedQuizData.moduleName;
      window.preloadedCategory = window.preloadedQuizData.category;
      window.isComprehensive = window.preloadedQuizData.isComprehensive;
      window.isCategoryQuiz = window.preloadedQuizData.isCategoryQuiz;
      window.autostart = window.preloadedQuizData.autostart;
      window.quizLength = window.preloadedQuizData.quizLength;
      window.backUrl = "{{ back_url | default('/', true) }}";
      window.backLabel = "{{ back_label | default('Home', true) }}";
      
      console.log('[Quiz] Preloaded data:', {
        hasQuizData: true,
        moduleName: window.preloadedQuizData.moduleName,
        category: window.preloadedQuizData.category,
        questionCount: window.preloadedQuizData.questions.length,
        isComprehensive: window.preloadedQuizData.isComprehensive,
        isCategoryQuiz: window.preloadedQuizData.isCategoryQuiz,
        autostart: window.preloadedQuizData.autostart,
        quizLength: window.preloadedQuizData.quizLength
      });
    })();
    {% else %}
    console.log('[Quiz] No preloaded data - will fetch from fixtures');
    {% endif %}
  </script>

  <!-- Quiz Script -->
  <script src="/static/quiz-script.js"></script>
</body>
</html>
